<html>
<head>
	<title>Virtual Patient Assistant</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript">
		nlp = window.nlp_compromise;

		var accessToken = "872500f5983f46568df07d5ab0305eed";
		var baseUrl = "https://api.api.ai/v1/";
		var messages = [], //array that hold the record of each string in chat
  lastUserMessage = "", //keeps track of the most recent input string from the user
  botMessage = "", //var keeps track of what the chatbot is going to say
  botName = 'Dr. Who'; //name of the chatbot
 

		$(document).ready(function() {
			$("#chatbox").keypress(function(event) {
				if (event.which == 13) {
					event.preventDefault();
					//send();
					newEntry();
				}
			});
			$("#rec").click(function(event) {
				switchRecognition();
			});
			$("#event").click(function(event) {

	newEntry();
		$.ajax({
				type: "POST",
				url: baseUrl + "contexts?sessionId=241187",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				headers: {
					"Authorization": "Bearer " + accessToken
				},
				data: JSON.stringify([{ 'name': 'medication-followup', 'lifespan': 5 }]),
			});
	$.ajax({
				type: "POST",
				url: baseUrl + "query?v=20150910",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				headers: {
					"Authorization": "Bearer " + accessToken
				},
				data: JSON.stringify({ 'event': { 'name': 'prescription_event', 'data': { 'doctor': 'DrSAM', 'disease': 'Cold', 'medicine': 'CROCINCOLD&FLUMAXTABLETS', 'days': '20' } }, 'timezone': 'America/New_York', 'lang': 'en', 'sessionId': '241187'}),

				success: function(data) {
						setResponse(JSON.stringify(data, undefined, 2));
					setAudioResponse(data);
					
				},
				error: function() {
					setResponse("Internal Server Error");
				}
			});
			});
		});

		var recognition;

		function startRecognition() {
			recognition = new webkitSpeechRecognition();
			recognition.onstart = function(event) {
				updateRec();
			};
			recognition.onresult = function(event) {
				var text = "";
			    for (var i = event.resultIndex; i < event.results.length; ++i) {
			    	text += event.results[i][0].transcript;
			    }
			    setInput(text);
				stopRecognition();
			};
			recognition.onend = function() {
				stopRecognition();
			};
			recognition.lang = "en-US";
			recognition.start();
		}
	
		function stopRecognition() {
			if (recognition) {
				recognition.stop();
				recognition = null;
			}
			updateRec();
		}

		function switchRecognition() {
			if (recognition) {
				stopRecognition();
			} else {
				startRecognition();
			}
		}

		function setInput(text) {
			$("#chatbox").val(text);
			// send();
			newEntry();
		}

		function updateRec() {
			// $("#rec").text(recognition ? "Stop" : "Speak");
			image_url = (recognition ? "microphone-309680_960_720.png" : "microphone-2104091_960_720.png" )
			$("#rec").css('background-image', 'url(' + image_url + ')');
		}

		function send() {
			//var text = $("#chatbox").val();
			var text = lastUserMessage;
			$.ajax({
				type: "POST",
				url: baseUrl + "query?v=20150910",
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				headers: {
					"Authorization": "Bearer " + accessToken
				},
				data: JSON.stringify({ query: text, lang: "en", sessionId: "241187" }),

				success: function(data) {
						setResponse(JSON.stringify(data, undefined, 2));
					setAudioResponse(data);
					
				},
				error: function() {
					setResponse("Internal Server Error");
				}
			});
			setResponse("Loading...");
		}

		function setResponse(val) {
			$("#response").text(val);
            }
			
			function setAudioResponse(val) {
			<!-- $("#response").text(val); -->
			if (val.result) {
                var say=""; 
                say = val.result.fulfillment.messages;
				for (var j = 0; j < say.length; j++)
				{
				botMessage = say[j].speech;
				messages.push("<b>" + botName + ":</b> " + botMessage);
			   for (var i = 1; i < 11; i++) {
      if (messages[messages.length - i])
        $("#chatlog" + i).html(messages[messages.length - i]);
		}
                synth = window.speechSynthesis;
                var utterThis = new SpeechSynthesisUtterance(say);
                //utterThis.lang = "en-US";
                synth.speak(utterThis);
            }
			}
		}
  //this runs each time enter is pressed.
//It controls the overall input and output
function newEntry() {
  //if the message from the user isn't empty then run 
  if ($("#chatbox").val() != "") {
    //pulls the value from the chatbox ands sets it to lastUserMessage
    lastUserMessage = $("#chatbox").val();
    //sets the chat box to be clear
    $("#chatbox").val("");
    //adds the value of the chatbox to the array messages
    messages.push("<b>Me: </b>" + lastUserMessage);
    //Speech(lastUserMessage);  //says what the user typed outloud
    //sets the variable botMessage in response to lastUserMessage
    send();
	// botMessage = '';
    //add the chatbot's name and message to the array messages
//    messages.push("<b>" + botName + ":</b> " + botMessage);
    // says the message using the text to speech function written below
    //outputs the last few array elements of messages to html
    for (var i = 1; i < 11; i++) {
      if (messages[messages.length - i])
        $("#chatlog" + i).html(messages[messages.length - i]);
    }
  }
}

//clears the placeholder text ion the chatbox
//this function is set to run when the users brings focus to the chatbox, by clicking on it
$("#chatbox").focus(function () {
$(this).attr("placeholder", "");
});
	</script>
	<style type="text/css">
		body {
  font: 15px arial, sans-serif;
  background-color: #d9d9d9;
  padding-top: 15px;
  padding-bottom: 15px;
  background-image: url("904.jpg");
  background-size: 100% 100%;
  background-repeat: no-repeat;
}

#bodybox {
  margin: auto;
  max-width: 550px;
  font: 15px arial, sans-serif;
  background-color: white;
  border-style: solid;
  border-width: 1px;
  padding-top: 20px;
  padding-bottom: 25px;
  padding-right: 25px;
  padding-left: 25px;
  box-shadow: 5px 5px 5px grey;
  border-radius: 15px;
  margin-left: 600px;
}

#chatborder {
  border-style: solid;
  background-color: #f6f9f6;
  border-width: 3px;
  margin-top: 20px;
  margin-bottom: 20px;
  margin-left: 20px;
  margin-right: 20px;
  padding-top: 10px;
  padding-bottom: 15px;
  padding-right: 20px;
  padding-left: 15px;
  border-radius: 15px;
}

.chatlog {
   font: 15px arial, sans-serif;
}

#chatbox {
  font: 17px arial, sans-serif;
  height: 30px;
  width: 90%;
  margin-right: 10px;
}

h1 {
  margin: auto;
}

pre {
  background-color: #f0f0f0;
  margin-left: 20px;
}

#rec {
    position: absolute;
    background:url("microphone-2104091_960_720.png");
	background-size: 100% 100%;
    background-repeat: no-repeat;
    width:40px;
    height:40px;
	border-style: none;
	margin: auto;
}
h1 {
    text-align: center;
}
	</style>
</head>
<body>
<div id='bodybox'>
<h1> Ask the Doctor - Your Personal Assistant</h1>
  <div id='chatborder'>
   <p id="chatlog11" class="chatlog">&nbsp;</p>
    <p id="chatlog10" class="chatlog">&nbsp;</p>
	 <p id="chatlog9" class="chatlog">&nbsp;</p>
    <p id="chatlog7" class="chatlog">&nbsp;</p>
    <p id="chatlog6" class="chatlog">&nbsp;</p>
    <p id="chatlog5" class="chatlog">&nbsp;</p>
    <p id="chatlog4" class="chatlog">&nbsp;</p>
    <p id="chatlog3" class="chatlog">&nbsp;</p>
    <p id="chatlog2" class="chatlog">&nbsp;</p>
    <p id="chatlog1" class="chatlog">&nbsp;</p>
    <input type="text" name="chat" id="chatbox" placeholder="Hi there! Type or Speak here to talk to me."><button id="rec"></button>
	

  </div>
  <button id="event">Use Case 2</button>
<!--	<div>
		 <input id="input" type="text"> <button id="rec">Speak</button> 
		 <br>Response<br> <textarea id="response" cols="40" rows="20"></textarea>	
		
	</div>-->
</body>
</html>